---
// LanguageSwitcher.astro - Premium language switcher (desktop dropdown + mobile inline list)
import { locales, localeLabels, type Locale } from '../i18n/config';
import { switchLocaleUrl, getLocaleFromUrl } from '../i18n/utils';

interface Props {
  locale?: Locale;
  mobile?: boolean;
}

const locale = Astro.props.locale ?? getLocaleFromUrl(Astro.url);
const mobile = Astro.props.mobile ?? false;
const currentPath = Astro.url.pathname;
---

{mobile ? (
  <!-- Mobile: inline list of language links (no dropdown needed) -->
  <div class="lang-switcher-mobile">
    <div class="flex items-center gap-2 px-4 py-2 text-xs font-medium text-white/40 uppercase tracking-wider">
      <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5a17.92 17.92 0 0 1-8.716-2.247m0 0A8.966 8.966 0 0 1 3 12c0-1.97.633-3.794 1.708-5.282" />
      </svg>
      <span>Language</span>
    </div>
    <div class="grid grid-cols-2 gap-1 px-2">
      {locales.map(loc => (
        <a
          href={switchLocaleUrl(currentPath, loc)}
          class:list={[
            'px-3 py-2.5 rounded-lg text-sm transition-all duration-200 text-center',
            loc === locale
              ? 'text-gold font-medium bg-white/[0.08] border border-gold/20'
              : 'text-white/60 hover:text-white hover:bg-white/[0.04]',
          ]}
          {...(loc === locale ? { 'aria-current': 'true' } : {})}
        >
          {localeLabels[loc]}
        </a>
      ))}
    </div>
  </div>
) : (
  <!-- Desktop: dropdown language switcher -->
  <div class="relative" id="lang-switcher">
    <button
      id="lang-toggle"
      class="flex items-center gap-1.5 text-sm text-white/60 hover:text-white px-2.5 py-2 rounded-lg transition-all duration-200 hover:bg-white/[0.04]"
      aria-expanded="false"
      aria-haspopup="true"
      aria-label="Select language"
    >
      <!-- Globe icon -->
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5a17.92 17.92 0 0 1-8.716-2.247m0 0A8.966 8.966 0 0 1 3 12c0-1.97.633-3.794 1.708-5.282" />
      </svg>
      <span>{localeLabels[locale]}</span>
      <!-- Chevron icon -->
      <svg class="w-3 h-3 transition-transform duration-200" id="lang-chevron" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
      </svg>
    </button>

    <!-- Dropdown panel -->
    <div
      id="lang-dropdown"
      class="hidden absolute right-0 top-full mt-2 min-w-[160px] py-2 rounded-xl bg-[#0F2337]/95 backdrop-blur-xl border border-white/[0.06] shadow-[0_8px_32px_rgba(0,0,0,0.3)] z-60 opacity-0 -translate-y-1 transition-all duration-200"
      role="menu"
      aria-label="Language options"
    >
      {locales.map(loc => (
        <a
          href={switchLocaleUrl(currentPath, loc)}
          class:list={[
            'flex items-center gap-2 px-4 py-2 text-sm transition-colors duration-150',
            loc === locale
              ? 'text-gold font-medium bg-white/[0.06]'
              : 'text-white/60 hover:text-white hover:bg-white/[0.04]',
          ]}
          role="menuitem"
          {...(loc === locale ? { 'aria-current': 'true' } : {})}
        >
          {loc === locale && (
            <span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>
          )}
          <span class:list={[loc !== locale && 'ml-3']}>
            {localeLabels[loc]}
          </span>
        </a>
      ))}
    </div>
  </div>
)}

<script>
  // Desktop dropdown toggle
  const toggle = document.getElementById('lang-toggle');
  const dropdown = document.getElementById('lang-dropdown');
  const chevron = document.getElementById('lang-chevron');

  function openDropdown() {
    if (!dropdown || !toggle) return;
    dropdown.classList.remove('hidden');
    // Trigger reflow for transition
    void dropdown.offsetHeight;
    dropdown.classList.remove('opacity-0', '-translate-y-1');
    dropdown.classList.add('opacity-100', 'translate-y-0');
    chevron?.classList.add('rotate-180');
    toggle.setAttribute('aria-expanded', 'true');
  }

  function closeDropdown() {
    if (!dropdown || !toggle) return;
    dropdown.classList.remove('opacity-100', 'translate-y-0');
    dropdown.classList.add('opacity-0', '-translate-y-1');
    chevron?.classList.remove('rotate-180');
    toggle.setAttribute('aria-expanded', 'false');
    // Hide after transition
    setTimeout(() => {
      dropdown.classList.add('hidden');
    }, 200);
  }

  if (toggle && dropdown) {
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown.classList.contains('hidden');
      if (isHidden) {
        openDropdown();
      } else {
        closeDropdown();
      }
    });

    // Close on click outside
    document.addEventListener('click', () => {
      if (!dropdown.classList.contains('hidden')) {
        closeDropdown();
      }
    });

    // Prevent dropdown click from closing
    dropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !dropdown.classList.contains('hidden')) {
        closeDropdown();
        toggle.focus();
      }
    });
  }
</script>
