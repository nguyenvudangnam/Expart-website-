---
// TableOfContents.astro - Premium sticky sidebar TOC
interface Props {
  headings: { id: string; text: string; depth: number }[];
}

const { headings } = Astro.props;
---

<aside id="toc-sidebar" class="hidden lg:block sticky top-24 self-start w-56 shrink-0" aria-label="Table of contents">
  <p class="text-xs font-semibold uppercase tracking-[0.15em] text-gold/70 mb-3">On this page</p>
  <nav>
    <ul class="flex flex-col gap-1 border-l-2 border-border-light">
      {headings.map(h => (
        <li>
          <a
            href={`#${h.id}`}
            class:list={[
              'toc-link block text-sm leading-snug py-1 transition-colors hover:text-navy border-l-2 -ml-[2px]',
              h.depth === 2 ? 'pl-4 text-text-muted border-transparent' : 'pl-7 text-text-muted/70 border-transparent text-xs',
            ]}
            data-heading-id={h.id}
          >
            {h.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<!-- Mobile TOC dropdown -->
<details class="lg:hidden mb-6 border border-border-light rounded-xl bg-surface p-4">
  <summary class="text-sm font-semibold text-navy cursor-pointer select-none">
    ðŸ“– Table of Contents
  </summary>
  <nav class="mt-3">
    <ul class="flex flex-col gap-1.5">
      {headings.map(h => (
        <li>
          <a
            href={`#${h.id}`}
            class:list={[
              'block text-sm text-text-muted hover:text-navy transition-colors',
              h.depth === 3 ? 'pl-4 text-xs' : '',
            ]}
          >
            {h.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</details>

<script>
  // Highlight active TOC link on scroll
  const tocLinks = document.querySelectorAll('.toc-link');
  const headingEls = Array.from(tocLinks).map(link => {
    const id = link.getAttribute('data-heading-id');
    return id ? document.getElementById(id) : null;
  }).filter(Boolean);

  if (headingEls.length > 0) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => {
            link.classList.remove('text-navy', 'font-medium', 'border-gold');
            link.classList.add('border-transparent');
          });
          const active = document.querySelector(`.toc-link[data-heading-id="${entry.target.id}"]`);
          if (active) {
            active.classList.add('text-navy', 'font-medium', 'border-gold');
            active.classList.remove('border-transparent');
          }
        }
      });
    }, { rootMargin: '-80px 0px -70% 0px', threshold: 0 });

    headingEls.forEach(el => { if (el) observer.observe(el); });
  }
</script>
