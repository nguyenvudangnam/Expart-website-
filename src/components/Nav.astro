---
// Nav.astro - Premium glassmorphism navigation (i18n-aware)
import { t, getLocaleFromUrl, localizedUrl } from '../i18n/utils';
import type { Locale } from '../i18n/config';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface Props {
  locale?: Locale;
}

const locale = Astro.props.locale ?? getLocaleFromUrl(Astro.url);

const navLinks = [
  { href: '/renting', labelKey: 'nav.renting' },
  { href: '/visa', labelKey: 'nav.visa' },
  { href: '/business', labelKey: 'nav.business' },
  { href: '/family', labelKey: 'nav.family' },
  { href: '/documents', labelKey: 'nav.documents' },
  { href: '/how-it-works', labelKey: 'nav.howItWorks' },
];

const currentPath = Astro.url.pathname;
---

<nav
  id="main-nav"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  aria-label="Main navigation"
>
  <div class="nav-backdrop absolute inset-0 bg-navy/95 backdrop-blur-xl border-b border-white/[0.06] shadow-[0_4px_30px_rgba(0,0,0,0.15)]"></div>

  <div class="relative max-w-6xl mx-auto px-6">
    <div class="flex items-center justify-between h-[4.25rem]">

      <!-- Logo -->
      <a href={localizedUrl(locale, '/')} class="flex items-center gap-2.5 group">
        <span class="flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-gold to-gold-bright text-white text-sm font-bold shadow-[0_2px_10px_rgba(200,148,74,0.3)]">⚖</span>
        <span class="font-heading font-semibold text-lg text-white tracking-tight">
          Expat Legal <span class="text-transparent bg-clip-text bg-gradient-to-r from-gold to-gold-bright">Vietnam</span>
        </span>
      </a>

      <!-- Desktop nav links -->
      <div class="hidden lg:flex items-center gap-1">
        {navLinks.map(link => {
          const href = localizedUrl(locale, link.href);
          return (
            <a
              href={href}
              class:list={[
                'relative text-sm font-medium px-3 py-2 rounded-lg transition-all duration-200',
                currentPath === href
                  ? 'text-gold bg-white/[0.06]'
                  : 'text-white/60 hover:text-white hover:bg-white/[0.04]',
              ]}
            >
              {t(locale, link.labelKey)}
              {currentPath === href && (
                <span class="absolute bottom-0 left-3 right-3 h-[2px] bg-gradient-to-r from-gold to-gold-bright rounded-full"></span>
              )}
            </a>
          );
        })}
      </div>

      <!-- Desktop: Language switcher + CTA -->
      <div class="hidden lg:flex items-center gap-3">
        <LanguageSwitcher locale={locale} />
        <a
          href={localizedUrl(locale, '/book')}
          class="inline-flex items-center gap-2 btn-gold text-white text-sm font-semibold px-5 py-2.5 rounded-lg"
        >
          {t(locale, 'nav.bookCall')}
        </a>
      </div>

      <!-- Mobile hamburger button -->
      <button
        id="mobile-menu-toggle"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
        class="lg:hidden flex flex-col gap-[5px] p-2.5 rounded-lg hover:bg-white/[0.06] transition-colors"
      >
        <span class="block w-5 h-[1.5px] bg-white/80 rounded-full transition-all duration-300 origin-center" id="bar1"></span>
        <span class="block w-5 h-[1.5px] bg-white/80 rounded-full transition-all duration-300" id="bar2"></span>
        <span class="block w-5 h-[1.5px] bg-white/80 rounded-full transition-all duration-300 origin-center" id="bar3"></span>
      </button>
    </div>

    <!-- Mobile menu -->
    <div
      id="mobile-menu"
      class="lg:hidden hidden pb-5 pt-3"
      aria-hidden="true"
    >
      <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent mb-3"></div>
      <div class="flex flex-col gap-1">
        {navLinks.map(link => {
          const href = localizedUrl(locale, link.href);
          return (
            <a
              href={href}
              class:list={[
                'px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200',
                currentPath === href
                  ? 'text-gold bg-white/[0.08] border-l-2 border-gold'
                  : 'text-white/60 hover:text-white hover:bg-white/[0.04]',
              ]}
            >
              {t(locale, link.labelKey)}
            </a>
          );
        })}
        <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent my-2"></div>
        <LanguageSwitcher locale={locale} mobile />
        <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent my-2"></div>
        <a
          href={localizedUrl(locale, '/book')}
          class="flex items-center justify-center gap-2 btn-gold text-white text-sm font-semibold px-4 py-3.5 rounded-lg"
        >
          {t(locale, 'nav.bookCall')} →
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- Nav spacer -->
<div class="h-[4.25rem]" aria-hidden="true"></div>

<script>
  // Mobile menu toggle
  const toggle = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  const bar1 = document.getElementById('bar1');
  const bar2 = document.getElementById('bar2');
  const bar3 = document.getElementById('bar3');

  if (toggle && menu) {
    toggle.addEventListener('click', () => {
      const isOpen = menu.classList.toggle('hidden') === false;
      toggle.setAttribute('aria-expanded', String(isOpen));
      menu.setAttribute('aria-hidden', String(!isOpen));

      if (isOpen) {
        bar1?.classList.add('rotate-45', 'translate-y-[7px]');
        bar2?.classList.add('opacity-0', 'scale-x-0');
        bar3?.classList.add('-rotate-45', '-translate-y-[7px]');
      } else {
        bar1?.classList.remove('rotate-45', 'translate-y-[7px]');
        bar2?.classList.remove('opacity-0', 'scale-x-0');
        bar3?.classList.remove('-rotate-45', '-translate-y-[7px]');
      }
    });
  }

  // Scroll-based nav enhancement
  const nav = document.getElementById('main-nav');
  if (nav) {
    let lastScroll = 0;
    window.addEventListener('scroll', () => {
      const currentScroll = window.scrollY;
      if (currentScroll > 80) {
        nav.classList.add('shadow-xl');
      } else {
        nav.classList.remove('shadow-xl');
      }
      lastScroll = currentScroll;
    }, { passive: true });
  }
</script>
